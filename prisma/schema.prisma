generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  STORE_MANAGER
  SALES_EXECUTIVE
}

enum RetailProductType {
  FRAME
  SUNGLASS
  CONTACT_LENS
  ACCESSORY
}

enum VisionType {
  SINGLE_VISION
  PROGRESSIVE
  BIFOCAL
  ANTI_FATIGUE
  MYOPIA_CONTROL
}

enum LensIndex {
  INDEX_156
  INDEX_160
  INDEX_167
  INDEX_174
}

enum TintOption {
  CLEAR
  TINT
  PHOTOCHROMIC
  TRANSITION
}

enum LensCategory {
  ECONOMY
  STANDARD
  PREMIUM
  ULTRA
}

type OfferRuleConfig {
  comboPrice        Int?
  discountType      String?
  discountValue     Int?
  isSecondPairRule  Boolean?
  secondPairPercent Int?
}

type OrderFrameData {
  brand     String
  frameType String?
  mrp       Int
  subBrand  String?
}

type OrderLensData {
  brandLine String
  id        String
  index     String
  name      String
  price     Int
}

type OrderOfferData {
  baseTotal          Int
  /// Could not determine type: the field only had null or empty values in the sample set.
  categoryDiscount   Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  couponDiscount     Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  couponError        Json?
  effectiveBase      Int
  finalPayable       Int
  frameMRP           Int
  lensPrice          Int
  /// Could not determine type: the field only had null or empty values in the sample set.
  offersApplied      Json?
  priceComponents    OrderOfferDataPriceComponents[]
  /// Could not determine type: the field only had null or empty values in the sample set.
  secondPairDiscount Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  upsell             Json?
}

type OrderOfferDataPriceComponents {
  amount Int
  label  String
}

model AnswerBenefit {
  id        String @id @default(auto()) @map("_id") @db.ObjectId
  answerId  String @db.ObjectId
  benefitId String @db.ObjectId
  points    Float  @default(0) // Benefit points (e.g. +1.5, +2.0, +3.0) - can be fractional

  answer  AnswerOption @relation(fields: [answerId], references: [id], onDelete: Cascade)
  benefit Benefit      @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([answerId, benefitId])
  @@index([answerId])
  @@index([benefitId])
}

model AnswerOption {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  icon                String?
  key                 String
  order               Int
  displayOrder        Int?
  questionId          String    @db.ObjectId
  text                String?
  textEn              String
  textHi              String?
  textHiEn            String?
  triggersSubQuestion Boolean   @default(false) // If true, this answer triggers a sub-question
  subQuestionId       String?   @db.ObjectId // ID of the sub-question to show after this answer
  createdAt           DateTime? @default(now()) // Made nullable to handle existing null records
  updatedAt           DateTime  @updatedAt

  question        Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  subQuestion     Question?       @relation("AnswerSubQuestion", fields: [subQuestionId], references: [id], onDelete: SetNull)
  benefitMappings AnswerBenefit[]

  @@unique([questionId, key])
  @@index([questionId])
  @@index([subQuestionId])
  @@index([triggersSubQuestion])
}

model Benefit {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  code           String           @unique // B01..B12 (fixed codes, can extend)
  name           String
  description    String?
  pointWeight    Float            @default(1.0) // Global importance weight
  maxScore       Float            @default(3.0) // Usually 3
  isActive       Boolean          @default(true)
  organizationId String           @db.ObjectId
  createdAt      DateTime         @default(now()) @db.Date
  updatedAt      DateTime         @updatedAt @db.Date
  AnswerBenefit  AnswerBenefit[]
  ProductBenefit ProductBenefit[]
  FeatureBenefit FeatureBenefit[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
}

model CategoryDiscount {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  brandCode        String
  createdAt        DateTime @db.Date
  customerCategory String
  discountPercent  Float
  isActive         Boolean
  maxDiscount      Float
  organizationId   String   @db.ObjectId
  updatedAt        DateTime @db.Date

  @@unique([organizationId, customerCategory, brandCode])
  @@index([organizationId])
  @@index([customerCategory])
  @@index([isActive])
}

model Coupon {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  code           String
  createdAt      DateTime  @default(now()) @db.Date
  discountType   String
  discountValue  Float
  isActive       Boolean   @default(true)
  maxDiscount    Float?
  minCartValue   Float?
  organizationId String    @db.ObjectId
  updatedAt      DateTime  @updatedAt @db.Date
  usedCount      BigInt    @default(0)
  usageLimit     Int?
  validFrom      DateTime  @db.Date
  validUntil     DateTime? @db.Date

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([code])
}

model Feature {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  code           String           @unique // F01..F11 (fixed codes)
  name           String
  description    String?
  category       String // DURABILITY, COATING, PROTECTION, LIFESTYLE, VISION
  displayOrder   Int // Order for display (1-11)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now()) @db.Date
  updatedAt      DateTime         @updatedAt @db.Date
  ProductFeature ProductFeature[]
  FeatureBenefit FeatureBenefit[]
  // Note: Features are global (no organizationId) - F01-F11 are fixed master data

  @@index([category])
  @@index([isActive])
  @@index([displayOrder])
}

model FeatureBenefit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  benefitId String   @db.ObjectId
  featureId String   @db.ObjectId
  weight    Float    @default(1.0)
  createdAt DateTime @default(now()) @db.Date
  updatedAt DateTime @updatedAt @db.Date
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  feature   Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([featureId, benefitId])
  @@index([featureId])
  @@index([benefitId])
}

model FeatureMapping {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  featureId  String @db.ObjectId
  optionKey  String
  questionId String @db.ObjectId
  weight     Float

  @@unique([questionId, optionKey, featureId])
  @@index([questionId])
  @@index([featureId])
}

// FrameBrand and FrameSubBrand removed - replaced by ProductBrand and ProductSubBrand

model Offer {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  code              String
  conditionBrand    String?
  conditionCategory String?
  conditionType     String
  conditionValue    Float?
  createdAt         DateTime @db.Date
  description       String
  discountValue     Float
  isActive          Boolean
  maxDiscount       Float?
  organizationId    String   @db.ObjectId
  priority          BigInt
  title             String
  type              String
  updatedAt         DateTime @db.Date
  validFrom         DateTime @db.Date

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
}

model OfferApplicationLog {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  /// Field referred in an index, but found no data to define the type.
  createdAt      Json?
  /// Field referred in an index, but found no data to define the type.
  orderId        Json?
  /// Field referred in an index, but found no data to define the type.
  organizationId Json?

  @@index([organizationId])
  @@index([orderId])
  @@index([createdAt])
}

model OfferRule {
  id                 String          @id @default(auto()) @map("_id") @db.ObjectId
  code               String
  config             OfferRuleConfig
  createdAt          DateTime        @db.Date
  frameBrands        String[]
  frameSubCategories String[]
  isActive           Boolean
  lensBrandLines     String[]
  maxFrameMRP        Float?
  minFrameMRP        Float?
  offerType          String
  organizationId     String          @db.ObjectId
  priority           BigInt
  updatedAt          DateTime        @db.Date
  upsellEnabled      Boolean
  /// Could not determine type: the field only had null or empty values in the sample set.
  upsellRewardText   Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  upsellThreshold    Json?

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
  @@index([offerType])
}

model Order {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  /// Could not determine type: the field only had null or empty values in the sample set.
  assistedByName    Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  assistedByStaffId Json?
  createdAt         DateTime       @db.Date
  customerName      String?
  customerPhone     String?
  finalPrice        Float
  frameData         OrderFrameData
  lensData          OrderLensData
  offerData         OrderOfferData
  salesMode         String
  status            String
  storeId           String         @db.ObjectId
  updatedAt         DateTime       @db.Date

  @@index([storeId])
  @@index([status])
  @@index([createdAt])
  @@index([assistedByStaffId])
}

model Organization {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  baseLensPrice Float
  code          String   @unique
  createdAt     DateTime @db.Date
  isActive      Boolean
  name          String
  /// Nested objects had no data in the sample dataset to introspect a nested type.
  settings      Json
  updatedAt     DateTime @db.Date
}

model Prescription {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  /// Field referred in an index, but found no data to define the type.
  createdAt     Json?
  /// Field referred in an index, but found no data to define the type.
  customerPhone Json?
  /// Field referred in an index, but found no data to define the type.
  sessionId     Json?

  @@index([sessionId])
  @@index([customerPhone])
  @@index([createdAt])
}

// Old Product model removed - replaced by LensProduct

model LensBrand {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Date
  updatedAt   DateTime @updatedAt @db.Date

  @@index([isActive])
}

model LensProduct {
  id             String                 @id @default(auto()) @map("_id") @db.ObjectId
  itCode         String                 @unique
  name           String
  brandLine      String
  visionType     VisionType
  lensIndex      LensIndex
  tintOption     TintOption
  baseOfferPrice Float
  addOnPrice     Float?
  category       LensCategory
  yopoEligible   Boolean                @default(true)
  deliveryDays   Int                    @default(4)
  isActive       Boolean                @default(true)
  createdAt      DateTime               @default(now()) @db.Date
  updatedAt      DateTime               @updatedAt @db.Date
  rxRanges       LensRxRange[]
  benefits       ProductBenefit[]
  features       ProductFeature[]
  specs          ProductSpecification[]

  @@index([brandLine])
  @@index([visionType])
  @@index([lensIndex])
  @@index([category])
  @@index([isActive])
  @@index([yopoEligible])
}

model LensRxRange {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  lensId     String      @db.ObjectId
  sphMin     Float
  sphMax     Float
  cylMin     Float
  cylMax     Float
  addOnPrice Float       @default(0)
  createdAt  DateTime    @default(now()) @db.Date
  updatedAt  DateTime    @updatedAt @db.Date
  lens       LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)

  @@index([lensId])
}

model ProductBenefit {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  benefitId String      @db.ObjectId
  productId String      @db.ObjectId
  score     Float       @default(0)
  createdAt DateTime    @default(now()) @db.Date
  updatedAt DateTime    @updatedAt @db.Date
  product   LensProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  benefit   Benefit     @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([productId, benefitId])
  @@index([productId])
  @@index([benefitId])
}

model ProductBrand {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  name         String              @unique
  isActive     Boolean             @default(true)
  productTypes RetailProductType[]
  createdAt    DateTime            @default(now()) @db.Date
  updatedAt    DateTime            @updatedAt @db.Date
  subBrands    ProductSubBrand[]
  products     RetailProduct[]

  @@index([isActive])
}

model ProductFeature {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime    @default(now()) @db.Date
  updatedAt DateTime    @updatedAt @db.Date
  featureId String      @db.ObjectId
  productId String      @db.ObjectId
  product   LensProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  feature   Feature     @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([productId, featureId])
  @@index([productId])
  @@index([featureId])
}

model ProductSpecification {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  productId String      @db.ObjectId
  group     String?
  key       String
  value     String
  createdAt DateTime    @default(now()) @db.Date
  updatedAt DateTime    @updatedAt @db.Date
  product   LensProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([group])
}

model ProductSubBrand {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  brandId   String          @db.ObjectId
  name      String
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now()) @db.Date
  updatedAt DateTime        @updatedAt @db.Date
  brand     ProductBrand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  products  RetailProduct[]

  @@unique([brandId, name])
  @@index([brandId])
  @@index([isActive])
}

model Question {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  allowMultiple    Boolean
  category         String
  createdAt        DateTime? @default(now()) // Made nullable to handle existing null records
  displayOrder     Int?
  isActive         Boolean
  isRequired       Boolean
  key              String
  order            Int
  organizationId   String    @db.ObjectId
  parentAnswerId   String?   @db.ObjectId
  questionCategory String?
  questionType     String?
  code             String?
  text             String?
  textEn           String
  textHi           String?
  textHiEn         String?
  updatedAt        DateTime  @updatedAt

  options       AnswerOption[]
  subQuestionOf AnswerOption[] @relation("AnswerSubQuestion") // Questions that are sub-questions of answers

  @@unique([organizationId, key])
  @@index([organizationId])
  @@index([category])
  @@index([order])
  @@index([isActive])
  @@index([questionCategory])
  @@index([displayOrder])
  @@index([parentAnswerId])
}

model RetailProduct {
  id         String            @id @default(auto()) @map("_id") @db.ObjectId
  type       RetailProductType
  brandId    String            @db.ObjectId
  subBrandId String?           @db.ObjectId
  name       String?
  mrp        Float
  hsnCode    String?
  sku        String?
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now()) @db.Date
  updatedAt  DateTime          @updatedAt @db.Date
  brand      ProductBrand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  subBrand   ProductSubBrand?  @relation(fields: [subBrandId], references: [id], onDelete: SetNull)

  @@unique([brandId, subBrandId, name, type])
  @@index([type])
  @@index([brandId])
  @@index([subBrandId])
  @@index([isActive])
  @@index([sku])
}

model Session {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  category         String
  completedAt      DateTime @db.Date
  customerCategory String?
  /// Could not determine type: the field only had null or empty values in the sample set.
  customerEmail    Json?
  customerName     String
  customerPhone    String
  /// Could not determine type: the field only had null or empty values in the sample set.
  prescriptionId   Json?
  startedAt        DateTime @db.Date
  status           String
  storeId          String   @db.ObjectId
  userId           String   @db.ObjectId

  @@index([storeId])
  @@index([userId])
  @@index([status])
  @@index([startedAt])
  @@index([category])
  @@index([prescriptionId])
}

model SessionAnswer {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  answeredAt DateTime @db.Date
  optionId   String   @db.ObjectId
  questionId String   @db.ObjectId
  sessionId  String   @db.ObjectId

  @@index([sessionId])
  @@index([questionId])
}

model SessionRecommendation {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @db.Date
  isSelected Boolean
  matchScore Float
  productId  String   @db.ObjectId // Can be LensProduct or RetailProduct ID
  rank       BigInt
  sessionId  String   @db.ObjectId

  @@unique([sessionId, productId])
  @@index([sessionId])
  @@index([productId])
  @@index([matchScore])
}

model Staff {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  /// Field referred in an index, but found no data to define the type.
  status  Json?
  /// Field referred in an index, but found no data to define the type.
  storeId Json?

  @@index([storeId])
  @@index([status])
}

model Store {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  address        String
  city           String
  code           String
  createdAt      DateTime @db.Date
  email          String
  gstNumber      String
  isActive       Boolean
  name           String
  organizationId String   @db.ObjectId
  phone          String
  pincode        String
  state          String
  updatedAt      DateTime @db.Date

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([city])
  @@index([isActive])
}

model StoreProduct {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime @db.Date
  isAvailable   Boolean
  priceOverride Float?
  productId     String   @db.ObjectId
  stockQuantity BigInt
  storeId       String   @db.ObjectId
  updatedAt     DateTime @db.Date

  @@unique([storeId, productId])
  @@index([storeId])
  @@index([productId])
  @@index([isAvailable])
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt      DateTime  @db.Date
  email          String
  employeeId     String
  isActive       Boolean
  lastLoginAt    DateTime? @db.Date
  name           String
  organizationId String    @db.ObjectId
  passwordHash   String
  phone          String?
  role           String
  storeId        String?   @db.ObjectId
  updatedAt      DateTime  @db.Date

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([storeId])
  @@index([role])
  @@index([isActive])
}
