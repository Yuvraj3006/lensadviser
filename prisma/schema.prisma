generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  STORE_MANAGER
  SALES_EXECUTIVE
}

enum RetailProductType {
  FRAME
  SUNGLASS
  CONTACT_LENS
  ACCESSORY
}

enum VisionType {
  SINGLE_VISION
  PROGRESSIVE
  BIFOCAL
  ANTI_FATIGUE
  MYOPIA_CONTROL
}

enum LensIndex {
  INDEX_156
  INDEX_160
  INDEX_167
  INDEX_174
}

enum TintOption {
  CLEAR
  TINT
  PHOTOCHROMIC
  TRANSITION
}

enum LensCategory {
  ECONOMY
  STANDARD
  PREMIUM
  ULTRA
}

enum OrderType {
  EYEGLASSES
  LENS_ONLY
  POWER_SUNGLASS
  CONTACT_LENS_ONLY
}

type OfferRuleConfig {
  comboPrice               Int?
  discountType             String?
  discountValue            Int?
  isSecondPairRule         Boolean?
  secondPairPercent        Int?
  freeUnderYOPO            String?
  bonusFreeAllowed         Boolean?
  triggerMinBill           Int?
  bonusLimit               Int?
  bonusCategory            String?
  eligibleBrands           String[]
  eligibleCategories       String[]
  comboType                String?
  requiredFrameSubCategory String?
  requiredFrameCategory    String?
  requiredLensBrandLine    String?
  requiredVisionType       String?
  brandLineComboPrice      Int?
  frameCategoryComboPrice  Int?
  visionTypeComboPrice     Int?
  freeProductId            String?
  lensItCodes              String[]
  ruleType                 String?
}

type OrderFrameData {
  brand     String
  frameType String?
  mrp       Int
  subBrand  String?
}

type OrderLensData {
  brandLine        String
  id               String
  index            String
  name             String
  price            Int
  itCode           String? // Lens SKU
  visionType       String? // SINGLE_VISION, PROGRESSIVE, etc.
  basePrice        Int? // Base lens price
  finalLensPrice   Int? // Final price after band pricing
  powerBand        Json? // Power band information
  bandExtra        Int? // Extra charge from band pricing
  rxAddOnBreakdown Json? // Array of applied RX add-on charges with details
  totalRxAddOn     Int? // Total RX add-on charge
  tint             Json? // Tint selection data
  mirror           Json? // Mirror coating data
  thicknessWarning Boolean? // Thickness warning flag
  recommendedIndex String? // Recommended index for prescription
}

type OrderOfferData {
  baseTotal          Int
  /// Could not determine type: the field only had null or empty values in the sample set.
  categoryDiscount   Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  couponDiscount     Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  couponError        Json?
  effectiveBase      Int
  finalPayable       Int
  frameMRP           Int
  lensPrice          Int
  /// Could not determine type: the field only had null or empty values in the sample set.
  offersApplied      Json?
  priceComponents    OrderOfferDataPriceComponents[]
  /// Could not determine type: the field only had null or empty values in the sample set.
  secondPairDiscount Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  upsell             Json?
}

type OrderOfferDataPriceComponents {
  amount Int
  label  String
}

model AnswerBenefit {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  answerId       String @db.ObjectId
  benefitId      String @db.ObjectId
  points         Float  @default(0) // Benefit points (e.g. +1.5, +2.0, +3.0) - can be fractional
  categoryWeight Float  @default(1.0) // Category weight multiplier (e.g., screen-heavy answers amplify screen benefits)

  answer  AnswerOption @relation(fields: [answerId], references: [id], onDelete: Cascade)
  benefit Benefit      @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([answerId, benefitId])
  @@index([answerId])
  @@index([benefitId])
}

model AnswerOption {
  id                  String    @id @default(auto()) @map("_id") @db.ObjectId
  icon                String?
  key                 String
  order               Int
  displayOrder        Int?
  questionId          String    @db.ObjectId
  text                String?
  textEn              String
  textHi              String?
  textHiEn            String?
  triggersSubQuestion Boolean   @default(false) // If true, this answer triggers a sub-question
  subQuestionId       String?   @db.ObjectId // ID of the sub-question to show after this answer (legacy - single sub-question)
  nextQuestionIds     String[]  @default([]) // Array of question IDs for unlimited nesting support
  createdAt           DateTime? @default(now()) // Made nullable to handle existing null records
  updatedAt           DateTime  @updatedAt

  question        Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  subQuestion     Question?       @relation("AnswerSubQuestion", fields: [subQuestionId], references: [id], onDelete: SetNull)
  benefitMappings AnswerBenefit[]

  @@unique([questionId, key])
  @@index([questionId])
  @@index([subQuestionId])
  @@index([triggersSubQuestion])
}

// Unified master for Benefits and Features - simple single table
model BenefitFeature {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  type           String // 'BENEFIT' or 'FEATURE'
  code           String // B01..B12 for benefits, F01..F11 for features
  name           String
  description    String?
  // Benefit-specific fields (null for features)
  pointWeight    Float?   @default(1.0) // Global importance weight
  maxScore       Float?   @default(3.0) // Usually 3
  // Feature-specific fields (null for benefits)
  category       String? // DURABILITY, COATING, PROTECTION, LIFESTYLE, VISION
  displayOrder   Int? // Order for display
  // Common fields
  isActive       Boolean  @default(true)
  organizationId String?  @db.ObjectId // null for global features (F01-F11)
  createdAt      DateTime @default(now()) @db.Date
  updatedAt      DateTime @updatedAt @db.Date

  // Relations - Note: These will be updated after migration
  // answerMappings AnswerBenefit[]
  // productMappings ProductBenefit[]
  // productFeatureMappings ProductFeature[]

  @@unique([code, organizationId]) // Code unique per organization (or globally for features)
  @@index([type])
  @@index([organizationId])
  @@index([isActive])
  @@index([category])
  @@index([displayOrder])
}

// Legacy Benefit model - deprecated, use BenefitFeature with type='BENEFIT'
model Benefit {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  code           String           @unique // B01..B12 (fixed codes, can extend)
  name           String
  description    String?
  pointWeight    Float            @default(1.0) // Global importance weight
  maxScore       Float            @default(3.0) // Usually 3
  isActive       Boolean          @default(true)
  organizationId String           @db.ObjectId
  createdAt      DateTime         @default(now()) @db.Date
  updatedAt      DateTime         @updatedAt @db.Date
  AnswerBenefit  AnswerBenefit[]
  ProductBenefit ProductBenefit[]
  FeatureBenefit FeatureBenefit[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
}

model CategoryDiscount {
  id                           String   @id @default(auto()) @map("_id") @db.ObjectId
  brandCode                    String
  createdAt                    DateTime @db.Date
  customerCategory             String
  discountPercent              Float
  isActive                     Boolean
  maxDiscount                  Float
  organizationId               String   @db.ObjectId
  updatedAt                    DateTime @db.Date
  categoryVerificationRequired Boolean  @default(false) // If true, require ID proof upload
  allowedIdTypes               String[] @default([]) // Array of allowed ID types: ["STUDENT_ID", "DOCTOR_ID", "TEACHER_ID", "ARMY_ID", etc.]

  @@unique([organizationId, customerCategory, brandCode])
  @@index([organizationId])
  @@index([customerCategory])
  @@index([isActive])
  @@index([categoryVerificationRequired])
}

model Coupon {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  code           String
  createdAt      DateTime  @default(now()) @db.Date
  discountType   String
  discountValue  Float
  isActive       Boolean   @default(true)
  maxDiscount    Float?
  minCartValue   Float?
  organizationId String    @db.ObjectId
  updatedAt      DateTime  @updatedAt @db.Date
  usedCount      BigInt    @default(0)
  usageLimit     Int?
  validFrom      DateTime  @db.Date
  validUntil     DateTime? @db.Date

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([code])
}

// Legacy Feature model - deprecated, use BenefitFeature with type='FEATURE'
model Feature {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  code           String           @unique // F01..F11 (fixed codes)
  name           String
  description    String?
  category       String // DURABILITY, COATING, PROTECTION, LIFESTYLE, VISION
  displayOrder   Int // Order for display (1-11)
  iconUrl        String? // URL to feature icon image
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now()) @db.Date
  updatedAt      DateTime         @updatedAt @db.Date
  ProductFeature ProductFeature[]
  FeatureBenefit FeatureBenefit[]
  // Note: Features are global (no organizationId) - F01-F11 are fixed master data

  @@index([category])
  @@index([isActive])
  @@index([displayOrder])
}

// Legacy FeatureBenefit model - deprecated, removed in simplified structure
model FeatureBenefit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  benefitId String   @db.ObjectId
  featureId String   @db.ObjectId
  weight    Float    @default(1.0)
  createdAt DateTime @default(now()) @db.Date
  updatedAt DateTime @updatedAt @db.Date
  benefit   Benefit  @relation(fields: [benefitId], references: [id], onDelete: Cascade)
  feature   Feature  @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([featureId, benefitId])
  @@index([featureId])
  @@index([benefitId])
}

// Legacy FeatureMapping model - deprecated, removed in simplified structure
model FeatureMapping {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  featureId  String @db.ObjectId
  optionKey  String
  questionId String @db.ObjectId
  weight     Float

  @@unique([questionId, optionKey, featureId])
  @@index([questionId])
  @@index([featureId])
}

// FrameBrand and FrameSubBrand removed - replaced by ProductBrand and ProductSubBrand

model Offer {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  code              String
  conditionBrand    String?
  conditionCategory String?
  conditionType     String
  conditionValue    Float?
  createdAt         DateTime @db.Date
  description       String
  discountValue     Float
  isActive          Boolean
  maxDiscount       Float?
  organizationId    String   @db.ObjectId
  priority          BigInt
  title             String
  type              String
  updatedAt         DateTime @db.Date
  validFrom         DateTime @db.Date

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
}

model OfferApplicationLog {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  /// Field referred in an index, but found no data to define the type.
  createdAt      Json?
  /// Field referred in an index, but found no data to define the type.
  orderId        Json?
  /// Field referred in an index, but found no data to define the type.
  organizationId Json?

  @@index([organizationId])
  @@index([orderId])
  @@index([createdAt])
}

model OfferRule {
  id                 String          @id @default(auto()) @map("_id") @db.ObjectId
  code               String
  config             OfferRuleConfig
  createdAt          DateTime        @db.Date
  frameBrands        String[]
  frameSubCategories String[]
  isActive           Boolean
  lensBrandLines     String[]
  maxFrameMRP        Float?
  minFrameMRP        Float?
  offerType          String
  organizationId     String          @db.ObjectId
  priority           BigInt
  updatedAt          DateTime        @db.Date
  upsellEnabled      Boolean
  /// Could not determine type: the field only had null or empty values in the sample set.
  upsellRewardText   Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  upsellThreshold    Json?

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isActive])
  @@index([priority])
  @@index([offerType])
}

model Order {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  /// Could not determine type: the field only had null or empty values in the sample set.
  assistedByName    Json?
  /// Could not determine type: the field only had null or empty values in the sample set.
  assistedByStaffId Json?
  createdAt         DateTime          @db.Date
  customerName      String?
  customerPhone     String?
  finalPrice        Float
  frameData         OrderFrameData
  lensData          OrderLensData
  offerData         OrderOfferData
  orderType         OrderType         @default(EYEGLASSES)
  salesMode         String
  status            String
  storeId           String            @db.ObjectId
  updatedAt         DateTime          @db.Date
  categoryIdProof   Json? // ID proof upload data for category discounts
  offerAudits       OrderOfferAudit[]

  @@index([storeId])
  @@index([status])
  @@index([createdAt])
  @@index([assistedByStaffId])
  @@index([orderType])
}

// Order Offer Audit - tracks all offers applied to an order
model OrderOfferAudit {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId        String   @db.ObjectId
  offerCode      String // Offer rule code
  offerType      String // YOPO, COMBO_PRICE, FREE_LENS, etc.
  ruleSnapshot   Json // Full snapshot of offer rule at time of application
  discountAmount Float    @default(0)
  appliedAt      DateTime @default(now()) @db.Date
  appliedBy      String?  @db.ObjectId // Staff ID who applied (if applicable)
  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([offerCode])
  @@index([offerType])
  @@index([appliedAt])
}

model StoreOfferMap {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  offerRuleId   String    @db.ObjectId
  isActive      Boolean   @default(true)
  activatedAt   DateTime  @default(now()) @db.Date
  deactivatedAt DateTime? @db.Date
  createdAt     DateTime  @default(now()) @db.Date
  updatedAt     DateTime  @updatedAt @db.Date

  @@unique([storeId, offerRuleId])
  @@index([storeId])
  @@index([offerRuleId])
  @@index([isActive])
}

model Organization {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  baseLensPrice Float
  code          String   @unique
  createdAt     DateTime @db.Date
  isActive      Boolean
  name          String
  /// Nested objects had no data in the sample dataset to introspect a nested type.
  settings      Json
  updatedAt     DateTime @db.Date
}

model Prescription {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  /// Field referred in an index, but found no data to define the type.
  createdAt     Json?
  /// Field referred in an index, but found no data to define the type.
  customerPhone Json?
  /// Field referred in an index, but found no data to define the type.
  sessionId     Json?

  @@index([sessionId])
  @@index([customerPhone])
  @@index([createdAt])
}

// Old Product model removed - replaced by LensProduct

// NOTE: LensBrand is for reference/display purposes only
// LensProduct uses brandLine (String) field, NOT a relation to LensBrand
// LensBrand.name should match LensProduct.brandLine values for consistency
// This is a loose coupling - LensBrand is not enforced as a foreign key
model LensBrand {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  name         String   @unique // Should match LensProduct.brandLine values
  description  String?
  isActive     Boolean  @default(true)
  comboAllowed Boolean  @default(false) // For COMBO eligibility
  yopoAllowed  Boolean  @default(false) // For YOPO eligibility
  createdAt    DateTime @default(now()) @db.Date
  updatedAt    DateTime @updatedAt @db.Date

  @@index([isActive])
  @@index([comboAllowed])
  @@index([yopoAllowed])
}

model LensProduct {
  id                String                     @id @default(auto()) @map("_id") @db.ObjectId
  itCode            String                     @unique
  name              String
  brandLine         String
  visionType        VisionType
  lensIndex         LensIndex
  tintOption        TintOption
  mrp               Float? // MRP (Maximum Retail Price) - optional for backward compatibility
  baseOfferPrice    Float
  addOnPrice        Float?
  category          LensCategory
  yopoEligible      Boolean                    @default(true)
  comboAllowed      Boolean                    @default(false) // For COMBO eligibility (SKU-level)
  deliveryDays      Int                        @default(4)
  isActive          Boolean                    @default(true)
  createdAt         DateTime                   @default(now()) @db.Date
  updatedAt         DateTime                   @updatedAt @db.Date
  rxRanges          LensRxRange[]
  benefits          ProductBenefit[]
  features          ProductFeature[]
  specs             ProductSpecification[]
  tintColors        LensProductTintColor[]
  mirrorCoatings    LensProductMirrorCoating[]
  bandPricing       LensBandPricing[]
  powerAddOnPricing LensPowerAddOnPricing[]

  @@index([brandLine])
  @@index([visionType])
  @@index([lensIndex])
  @@index([category])
  @@index([isActive])
  @@index([yopoEligible])
  @@index([comboAllowed])
}

model LensRxRange {
  id         String      @id @default(auto()) @map("_id") @db.ObjectId
  lensId     String      @db.ObjectId
  sphMin     Float
  sphMax     Float
  cylMin     Float
  cylMax     Float
  addOnPrice Float       @default(0)
  createdAt  DateTime    @default(now()) @db.Date
  updatedAt  DateTime    @updatedAt @db.Date
  lens       LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)

  @@index([lensId])
}

// Band Pricing for power-based extra charges
model LensBandPricing {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  lensId      String      @db.ObjectId
  minPower    Float // Minimum power (absolute value)
  maxPower    Float // Maximum power (absolute value)
  extraCharge Float       @default(0) // Extra charge for this power band
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now()) @db.Date
  updatedAt   DateTime    @updatedAt @db.Date
  lens        LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)

  @@index([lensId])
  @@index([isActive])
}

// Combined RX Add-On Pricing - SPH + CYL + ADD based pricing
model LensPowerAddOnPricing {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  lensId      String      @db.ObjectId
  sphMin      Float? // SPH minimum (null = ANY)
  sphMax      Float? // SPH maximum (null = ANY)
  cylMin      Float? // CYL minimum (null = ANY)
  cylMax      Float? // CYL maximum (null = ANY)
  addMin      Float? // ADD minimum (null = ANY, optional)
  addMax      Float? // ADD maximum (null = ANY, optional)
  extraCharge Int // Extra charge in ₹
  createdAt   DateTime    @default(now()) @db.Date
  updatedAt   DateTime    @updatedAt @db.Date
  lens        LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)

  @@index([lensId])
}

enum TintColorCategory {
  SOLID
  GRADIENT
  FASHION
  POLARIZED
  PHOTOCHROMIC
}

model TintColor {
  id              String                  @id @default(auto()) @map("_id") @db.ObjectId
  code            String                  @unique
  name            String
  hexColor        String?
  imageUrl        String?
  category        TintColorCategory
  darknessPercent Int
  isPolarized     Boolean                 @default(false)
  isMirror        Boolean                 @default(false)
  basePrice       Float                   @default(0) // Base price for this tint
  isActive        Boolean                 @default(true)
  displayOrder    Int                     @default(0)
  createdAt       DateTime                @default(now()) @db.Date
  updatedAt       DateTime                @updatedAt @db.Date
  lensProducts    LensProductTintColor[]
  indexPricing    TintColorIndexPricing[] // Index-based pricing rules

  @@index([isActive])
  @@index([displayOrder])
  @@index([category])
}

// Index-based pricing for tint colors
model TintColorIndexPricing {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  tintColorId String    @db.ObjectId
  lensIndex   LensIndex // INDEX_156, INDEX_160, INDEX_167, INDEX_174
  priceFactor Float     @default(1.0) // Multiplier for base price (e.g., 1.2 = 20% extra)
  addOnPrice  Float     @default(0) // Fixed add-on price for this index
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now()) @db.Date
  updatedAt   DateTime  @updatedAt @db.Date
  tintColor   TintColor @relation(fields: [tintColorId], references: [id], onDelete: Cascade)

  @@unique([tintColorId, lensIndex])
  @@index([tintColorId])
  @@index([lensIndex])
  @@index([isActive])
}

model MirrorCoating {
  id           String                     @id @default(auto()) @map("_id") @db.ObjectId
  code         String                     @unique
  name         String
  imageUrl     String?
  addOnPrice   Float                      @default(0)
  isActive     Boolean                    @default(true)
  displayOrder Int                        @default(0)
  createdAt    DateTime                   @default(now()) @db.Date
  updatedAt    DateTime                   @updatedAt @db.Date
  lensProducts LensProductMirrorCoating[]

  @@index([isActive])
  @@index([displayOrder])
}

model LensProductTintColor {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  lensId      String      @db.ObjectId
  tintColorId String      @db.ObjectId
  lens        LensProduct @relation(fields: [lensId], references: [id], onDelete: Cascade)
  tintColor   TintColor   @relation(fields: [tintColorId], references: [id], onDelete: Cascade)

  @@unique([lensId, tintColorId])
  @@index([lensId])
  @@index([tintColorId])
}

model LensProductMirrorCoating {
  id              String        @id @default(auto()) @map("_id") @db.ObjectId
  lensId          String        @db.ObjectId
  mirrorCoatingId String        @db.ObjectId
  lens            LensProduct   @relation(fields: [lensId], references: [id], onDelete: Cascade)
  mirrorCoating   MirrorCoating @relation(fields: [mirrorCoatingId], references: [id], onDelete: Cascade)

  @@unique([lensId, mirrorCoatingId])
  @@index([lensId])
  @@index([mirrorCoatingId])
}

enum ContactLensModality {
  DAILY
  BIWEEKLY
  MONTHLY
  YEARLY
}

enum ContactLensType {
  SPHERICAL
  TORIC
  MULTIFOCAL
  COSMETIC
}

model ContactLensProduct {
  id            String              @id @default(auto()) @map("_id") @db.ObjectId
  skuCode       String              @unique
  brand         String
  line          String
  modality      ContactLensModality
  lensType      ContactLensType
  material      String?
  waterContent  String?
  designNotes   String?
  packSize      Int
  mrp           Float
  offerPrice    Float
  sphMin        Float?
  sphMax        Float?
  cylMin        Float?
  cylMax        Float?
  axisSteps     String? // JSON array of numbers
  addMin        Float?
  addMax        Float?
  isColorLens   Boolean             @default(false)
  colorOptions  String? // JSON array of color names
  benefitScores String? // JSON object: { "B01": 2.5, "B02": 3.0 } - Benefit code to score mapping (0-3 scale)
  isActive      Boolean             @default(true)
  createdAt     DateTime            @default(now()) @db.Date
  updatedAt     DateTime            @updatedAt @db.Date

  @@index([brand])
  @@index([modality])
  @@index([lensType])
  @@index([isActive])
}

model ProductBenefit {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  benefitId String      @db.ObjectId
  productId String      @db.ObjectId
  score     Float       @default(0)
  createdAt DateTime    @default(now()) @db.Date
  updatedAt DateTime    @updatedAt @db.Date
  product   LensProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  benefit   Benefit     @relation(fields: [benefitId], references: [id], onDelete: Cascade)

  @@unique([productId, benefitId])
  @@index([productId])
  @@index([benefitId])
}

model ProductBrand {
  id           String              @id @default(auto()) @map("_id") @db.ObjectId
  name         String              @unique
  isActive     Boolean             @default(true)
  productTypes RetailProductType[]
  comboAllowed Boolean             @default(false) // For COMBO eligibility (brand-wise)
  yopoAllowed  Boolean             @default(false) // For YOPO eligibility (brand-wise)
  createdAt    DateTime            @default(now()) @db.Date
  updatedAt    DateTime            @updatedAt @db.Date
  subBrands    ProductSubBrand[]
  products     RetailProduct[]

  @@index([isActive])
  @@index([comboAllowed])
  @@index([yopoAllowed])
}

model ProductFeature {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime    @default(now()) @db.Date
  updatedAt DateTime    @updatedAt @db.Date
  featureId String      @db.ObjectId
  productId String      @db.ObjectId
  product   LensProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  feature   Feature     @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@unique([productId, featureId])
  @@index([productId])
  @@index([featureId])
}

model ProductSpecification {
  id        String      @id @default(auto()) @map("_id") @db.ObjectId
  productId String      @db.ObjectId
  group     String?
  key       String
  value     String
  createdAt DateTime    @default(now()) @db.Date
  updatedAt DateTime    @updatedAt @db.Date
  product   LensProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([group])
}

model ProductSubBrand {
  id        String          @id @default(auto()) @map("_id") @db.ObjectId
  brandId   String          @db.ObjectId
  name      String
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now()) @db.Date
  updatedAt DateTime        @updatedAt @db.Date
  brand     ProductBrand    @relation(fields: [brandId], references: [id], onDelete: Cascade)
  products  RetailProduct[]

  @@unique([brandId, name])
  @@index([brandId])
  @@index([isActive])
}

model Question {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  allowMultiple    Boolean
  category         String
  createdAt        DateTime? @default(now()) // Made nullable to handle existing null records
  displayOrder     Int?
  isActive         Boolean
  isRequired       Boolean
  key              String
  order            Int
  organizationId   String    @db.ObjectId
  parentAnswerId   String?   @db.ObjectId
  questionCategory String?
  questionType     String?
  code             String?
  text             String?
  textEn           String
  textHi           String?
  textHiEn         String?
  updatedAt        DateTime  @updatedAt

  options       AnswerOption[]
  subQuestionOf AnswerOption[] @relation("AnswerSubQuestion") // Questions that are sub-questions of answers

  @@unique([organizationId, key])
  @@index([organizationId])
  @@index([category])
  @@index([order])
  @@index([isActive])
  @@index([questionCategory])
  @@index([displayOrder])
  @@index([parentAnswerId])
}

model RetailProduct {
  id         String            @id @default(auto()) @map("_id") @db.ObjectId
  type       RetailProductType
  brandId    String            @db.ObjectId
  subBrandId String?           @db.ObjectId
  name       String?
  mrp        Float
  hsnCode    String?
  sku        String?
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now()) @db.Date
  updatedAt  DateTime          @updatedAt @db.Date
  brand      ProductBrand      @relation(fields: [brandId], references: [id], onDelete: Cascade)
  subBrand   ProductSubBrand?  @relation(fields: [subBrandId], references: [id], onDelete: SetNull)

  @@unique([brandId, subBrandId, name, type])
  @@index([type])
  @@index([brandId])
  @@index([subBrandId])
  @@index([isActive])
  @@index([sku])
}

model Session {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  category          String
  completedAt       DateTime      @db.Date
  customerCategory  String?
  /// Could not determine type: the field only had null or empty values in the sample set.
  customerEmail     Json?
  customerName      String
  customerPhone     String
  /// Could not determine type: the field only had null or empty values in the sample set.
  prescriptionId    Json?
  startedAt         DateTime      @db.Date
  status            String
  storeId           String        @db.ObjectId
  userId            String        @db.ObjectId
  purchaseContext   String? // REGULAR | COMBO | YOPO
  selectedComboCode String? // Selected combo tier code (BRONZE, SILVER, GOLD, PLATINUM)
  comboVersionUsed  Int? // Combo tier version used when tier was selected (for safe updates)
  secondPairData    Json? // Second pair data for BOGO offers: { enabled, frameMRP, brand, subBrand, lensId, lensName, lensPrice }
  needsProfile      NeedsProfile? // One-to-one relationship

  @@index([storeId])
  @@index([userId])
  @@index([status])
  @@index([startedAt])
  @@index([category])
  @@index([prescriptionId])
  @@index([purchaseContext])
}

model SessionAnswer {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  answeredAt DateTime @db.Date
  optionId   String   @db.ObjectId
  questionId String   @db.ObjectId
  sessionId  String   @db.ObjectId

  @@index([sessionId])
  @@index([questionId])
}

model SessionRecommendation {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime @db.Date
  isSelected Boolean
  matchScore Float
  productId  String   @db.ObjectId // Can be LensProduct or RetailProduct ID
  rank       BigInt
  sessionId  String   @db.ObjectId

  @@unique([sessionId, productId])
  @@index([sessionId])
  @@index([productId])
  @@index([matchScore])
}

model Staff {
  id      String @id @default(auto()) @map("_id") @db.ObjectId
  /// Field referred in an index, but found no data to define the type.
  status  Json?
  /// Field referred in an index, but found no data to define the type.
  storeId Json?

  @@index([storeId])
  @@index([status])
}

model Store {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  address        String
  city           String
  code           String
  createdAt      DateTime @db.Date
  email          String
  gstNumber      String
  isActive       Boolean
  name           String
  organizationId String   @db.ObjectId
  phone          String
  pincode        String
  state          String
  updatedAt      DateTime @db.Date

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([city])
  @@index([isActive])
}

model StoreProduct {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime @db.Date
  isAvailable   Boolean
  priceOverride Float?
  productId     String   @db.ObjectId
  stockQuantity BigInt
  storeId       String   @db.ObjectId
  updatedAt     DateTime @db.Date

  @@unique([storeId, productId])
  @@index([storeId])
  @@index([productId])
  @@index([isAvailable])
}

model User {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt      DateTime  @db.Date
  email          String
  employeeId     String
  isActive       Boolean
  lastLoginAt    DateTime? @db.Date
  name           String
  organizationId String    @db.ObjectId
  passwordHash   String
  phone          String?
  role           String
  storeId        String?   @db.ObjectId
  updatedAt      DateTime  @db.Date

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([storeId])
  @@index([role])
  @@index([isActive])
}

// ============================================
// Combo + Regular Purchase Flow Models
// ============================================

// Global Configuration for Combo Feature
model Config {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @db.Date
  createdAt DateTime @default(now()) @db.Date
}

// Needs Profile from Questionnaire
model NeedsProfile {
  id                     String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionId              String   @unique @db.ObjectId
  session                Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  primaryUsage           String? // DAILY | SCREEN | DRIVING | OUTDOOR
  screenTime             String? // LOW | MEDIUM | HIGH
  drivingNight           Boolean? @default(false)
  outdoorFrequency       String? // LOW | MEDIUM | HIGH
  backupNeed             Boolean? @default(false)
  lensComplexity         String? // BASIC | ADVANCED | PREMIUM
  sensitivityFlags       String[] // Array of flags like ["GLARE", "DRY_EYES"]
  recommendSecondEyewear Boolean? @default(false)
  createdAt              DateTime @default(now()) @db.Date
  updatedAt              DateTime @updatedAt @db.Date
}

// Combo Tier Configuration
model ComboTier {
  id              String         @id @default(auto()) @map("_id") @db.ObjectId
  comboCode       String         @unique // BRONZE, SILVER, GOLD, PLATINUM
  displayName     String
  effectivePrice  Float
  totalComboValue Float? // Total value before discount (for showing original price with strikethrough)
  badge           String? // MOST_POPULAR, BEST_VALUE, etc.
  isActive        Boolean        @default(true)
  comboVersion    Int            @default(1) // Version number for safe updates
  sortOrder       Int            @default(0) // For display ordering
  organizationId  String?        @db.ObjectId // Optional: org-specific tiers
  benefits        ComboBenefit[]
  rules           ComboRule[]
  createdAt       DateTime       @default(now()) @db.Date
  updatedAt       DateTime       @updatedAt @db.Date

  @@index([isActive])
  @@index([organizationId])
  @@index([comboVersion])
}

// Combo Tier Benefits
model ComboBenefit {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  comboCode   String    @db.ObjectId
  comboTier   ComboTier @relation(fields: [comboCode], references: [id], onDelete: Cascade)
  benefitType String // frame | lens | eyewear | addon | voucher
  label       String
  maxValue    Float? // Optional max value for voucher/benefit
  constraints String? // JSON string for additional constraints
  createdAt   DateTime  @default(now()) @db.Date
  updatedAt   DateTime  @updatedAt @db.Date

  @@index([comboCode])
  @@index([benefitType])
}

// Voucher Model (for combo benefits)
model Voucher {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  orderId    String    @db.ObjectId // Order that issued this voucher
  sessionId  String?   @db.ObjectId // Session that used this voucher (if used)
  code       String    @unique // Voucher code
  value      Float // Voucher value in ₹
  validFrom  DateTime  @db.Date // Valid from date (next day after issue)
  validUntil DateTime  @db.Date // Valid until date (90 days after issue)
  isUsed     Boolean   @default(false)
  usedAt     DateTime? @db.Date
  issuedAt   DateTime  @default(now()) @db.Date
  createdAt  DateTime  @default(now()) @db.Date
  updatedAt  DateTime  @updatedAt @db.Date

  @@index([orderId])
  @@index([sessionId])
  @@index([isUsed])
  @@index([validFrom, validUntil])
}

// Combo Rules (for rule-based enforcement)
model ComboRule {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  comboCode String    @db.ObjectId // FK to ComboTier
  comboTier ComboTier @relation(fields: [comboCode], references: [id], onDelete: Cascade)
  ruleType  String // FRAME_BRAND_ALLOW | SUN_BRAND_ALLOW | LENS_SKU_ALLOW | SECOND_EYEWEAR_CHOICE | OFFER_STACK_POLICY | COUPON_POLICY | VOUCHER_POLICY
  ruleJson  String? // JSON string for rule configuration
  createdAt DateTime  @default(now()) @db.Date
  updatedAt DateTime  @updatedAt @db.Date

  @@index([comboCode])
  @@index([ruleType])
}
